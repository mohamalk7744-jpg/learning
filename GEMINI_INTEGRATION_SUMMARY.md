# ملخص تكامل Gemini API

## ما تم إنجازه

### 1. تكامل Gemini API ✅

- تم إنشاء ملف `server/_core/gemini.ts` للتعامل مع Gemini API
- تم إضافة `GEMINI_API_KEY` إلى `server/_core/env.ts`
- النموذج المستخدم: `gemini-2.0-flash-exp`

### 2. نظام Chat المتخصص ✅

- تم تحديث `server/routers.ts` لإضافة:
  - `chat.sendMessage`: يرسل رسالة للبوت مع التحقق من الصلاحيات
  - `chat.getHistory`: يجلب سجل المحادثة
  - `chat.getStudentSubjects`: يجلب المواد المشتركة للطالب

**الميزات:**
- ✅ التحقق من أن الطالب لديه صلاحية الوصول للمادة
- ✅ التخصص حسب المادة - كل مادة لها سياقها الخاص
- ✅ استخدام دروس المادة كسياق للبوت
- ✅ حفظ سجل المحادثة في قاعدة البيانات

### 3. تحديث واجهة Chat ✅

- تم تحديث `app/(tabs)/chat.tsx`:
  - اختيار المادة من قائمة المواد المشتركة
  - عرض سجل المحادثة من قاعدة البيانات
  - إرسال الرسائل عبر API
  - عرض حالة التحميل والأخطاء

### 4. نظام الصلاحيات ✅

- تم إضافة `getStudentSubjects` في `server/db.ts`:
  - يجلب جميع المواد التي للطالب صلاحية الوصول إليها
  - يستخدم `innerJoin` لربط `accessPermissions` مع `subjects`

### 5. إكمال الانتقالات في الدروس ✅

- تم إنشاء `app/lesson/[id].tsx` لعرض تفاصيل الدرس
- تم تحديث `app/(tabs)/schedule.tsx`:
  - جلب الدروس والاختبارات من قاعدة البيانات
  - اختيار المادة
  - الانتقال إلى صفحة الدرس عند الضغط على "ابدأ"

### 6. توثيق Render ✅

- تم إنشاء `RENDER_DEPLOYMENT_GUIDE.md`:
  - شرح كامل لكيفية ربط السيرفر على Render
  - قائمة بجميع المتغيرات المطلوبة
  - خطوات إعداد قاعدة البيانات
  - استكشاف الأخطاء

## كيفية الاستخدام

### 1. إعداد Gemini API Key

أضف في `.env` أو Environment Variables:
```bash
GEMINI_API_KEY=AIzaSyCkMe_7ryRa0L0HOPqRmvtORNxkC-pZxgI
```

### 2. إعداد قاعدة البيانات

تأكد من:
- وجود جدول `access_permissions` مع بيانات صحيحة
- أن `hasAccess = 1` للطلاب الذين لديهم صلاحية
- وجود دروس في جدول `lessons` لكل مادة

### 3. اختبار النظام

1. سجل دخول كطالب
2. تأكد من أن لديك صلاحية وصول لمادة واحدة على الأقل
3. اذهب إلى تبويب "البوت الذكي"
4. اختر مادة
5. اسأل سؤال متعلق بالمنهج

## كيف يعمل النظام

### عند إرسال رسالة:

1. **التحقق من الصلاحيات**: 
   - يتحقق النظام من أن الطالب لديه `hasAccess = 1` للمادة المختارة

2. **جلب السياق**:
   - يجلب جميع دروس المادة
   - يستخدم محتوى الدروس كسياق للبوت

3. **إنشاء System Instruction**:
   - يخصص البوت للمادة المحددة
   - يطلب من البوت الإجابة فقط على أسئلة هذه المادة
   - يمنع البوت من الإجابة على أسئلة خارج المنهج

4. **استدعاء Gemini**:
   - يرسل سجل المحادثة السابق + السؤال الحالي
   - يحصل على إجابة متخصصة

5. **حفظ النتيجة**:
   - يحفظ السؤال والإجابة في `chat_history`

## الأمان

- ✅ التحقق من الصلاحيات قبل كل طلب
- ✅ البوت يجيب فقط على المواد المشتركة للطالب
- ✅ البوت متخصص حسب المادة ولا يجيب خارج المنهج

## الخطوات التالية

1. **إضافة المفتاح في Render**:
   - اتبع `RENDER_DEPLOYMENT_GUIDE.md`
   - أضف `GEMINI_API_KEY` في Environment Variables

2. **اختبار محلياً**:
   - أضف `GEMINI_API_KEY` في `.env`
   - شغل `pnpm dev`
   - اختبر البوت

3. **النشر على Render**:
   - اتبع الدليل في `RENDER_DEPLOYMENT_GUIDE.md`
   - قدم المعلومات المطلوبة عند الحاجة للمساعدة

## ملاحظات

- البوت يستخدم `gemini-2.0-flash-exp` وهو نموذج سريع ومجاني نسبياً
- يمكن تغيير النموذج في `server/_core/gemini.ts` إذا لزم الأمر
- System Instruction يمكن تخصيصه أكثر حسب الحاجة

